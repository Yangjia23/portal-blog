<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、前端监控系统 | 前端壹甲壹</title>
    <meta name="description" content="Focus on Yourself!">
    <link rel="stylesheet" href="/portal-blog/assets/style.ad1c1f1c.css">
    <link rel="modulepreload" href="/portal-blog/assets/Home.85d9622a.js">
    <link rel="modulepreload" href="/portal-blog/assets/app.5a70c45b.js">
    <link rel="modulepreload" href="/portal-blog/assets/source-analysis_前端监控系统_1、数据采集与上报之SDK.md.75ecf6e4.lean.js">
    <link rel="modulepreload" href="/portal-blog/assets/app.5a70c45b.js">
    <meta name="twitter:title" content="一、前端监控系统 | 前端壹甲壹">
    <meta property="og:title" content="一、前端监控系统 | 前端壹甲壹">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/portal-blog/" aria-label="前端壹甲壹, back to home" data-v-675d8756 data-v-4a583abe><!----> 前端壹甲壹</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/frontend-graph/README" data-v-b8818f8c>前端图谱 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/project-develop/README" data-v-b8818f8c>项目实战 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/portal-blog/source-analysis/README" data-v-b8818f8c>学习总结 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/about/README" data-v-b8818f8c>关于 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/Yangjia23" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-15acbf05><!--[--><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/frontend-graph/README" data-v-b8818f8c>前端图谱 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/project-develop/README" data-v-b8818f8c>项目实战 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item active" href="/portal-blog/source-analysis/README" data-v-b8818f8c>学习总结 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item" href="/portal-blog/about/README" data-v-b8818f8c>关于 <!----></a></div></div><div class="item" data-v-15acbf05><div class="nav-link" data-v-15acbf05 data-v-b8818f8c><a class="item isExternal" href="https://github.com/Yangjia23" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><p class="sidebar-link-item">Visualization</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/Visualization/1、线性代数的本质-学习笔记">1、线性代数的本质-学习笔记</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">Vue2.x源码</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/Vue2.x源码/1、第一篇｜变化侦测">1、第一篇｜变化侦测</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">Webpack</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/Webpack/1、如何调试Webpack源码">1、如何调试Webpack源码</a><!----></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">前端监控系统</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item active" href="/portal-blog/source-analysis/前端监控系统/1、数据采集与上报之SDK">1、数据采集与上报之SDK</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#一、前端监控系统">一、前端监控系统</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#二、sdk-核心功能">二、SDK 核心功能</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-1、自动上报数据">2.1、自动上报数据</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-2、手动上报数据">2.2、手动上报数据</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-3、何时上报以及如何上报">2.3、何时上报以及如何上报</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三、总结">三、总结</a><!----></li></ul></li></ul></li><li class="sidebar-link"><p class="sidebar-link-item">前端运维</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/前端运维/1、Linux 命令汇总">1、Linux 命令汇总</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/前端运维/2、Vim命令汇总">2、Vim命令汇总</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/前端运维/3、文件权限">3、文件权限</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/portal-blog/source-analysis/前端运维/4、nginx学习">4、nginx学习</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><p>前端团队 Q4 阶段需要开发一个前端监控系统，有些小伙伴可能并不太清楚其相关内容，本专题会介绍其出现的原因、工作原理等，本文会重点介绍监控系统中的 SDK 核心功能，包括数据采集、自动上报、手动上报等</p><h2 id="一、前端监控系统"><a class="header-anchor" href="#一、前端监控系统" aria-hidden="true">#</a> 一、前端监控系统</h2><p>在开发之前，我们需要了解我们为什么需要前端监控系统，它将会帮助我们解决什么问题？</p><ul><li>保存记录线上 bug 出现的现场环节，利用 Bug 堆栈信息来定位 bug</li><li>统计分析用户所使用的系统分布、浏览器分布、设备分布等，找出我们的主要用户</li><li>统计前端优化前后的页面性能来判断某次性能优化方案是否成功</li><li>统计用户访问量、在线时长，以及业务模块的使用情况，为产品后续发展提供参考</li></ul><p>监控系统可以做的还有很多，而最主要的就是 “<strong>比用户更早发现问题，在用户发现问题之前解决问题</strong>&quot;</p><h2 id="二、sdk-核心功能"><a class="header-anchor" href="#二、sdk-核心功能" aria-hidden="true">#</a> 二、SDK 核心功能</h2><p><img src="/portal-blog/images/sdk/framework.png" alt="linear.png"></p><h3 id="_2-1、自动上报数据"><a class="header-anchor" href="#_2-1、自动上报数据" aria-hidden="true">#</a> 2.1、自动上报数据</h3><p>自动上报的数据不会破坏业务逻辑代码，只需要引入 SDK 即可</p><h4 id="_2-1-1、错误类型数据"><a class="header-anchor" href="#_2-1-1、错误类型数据" aria-hidden="true">#</a> 2.1.1、错误类型数据</h4><p>错误类型数据指的是运行过程中的前端报错，如 JS 语法错误、JS 解析报错、Vue 和 React 等常见框架的报错等，而每个错误对象都是 JS 中 Error 这个构造函数的实例，其具有 messgae 和 stack 两个属性</p><p>所以的报错可归纳成以下几种</p><ul><li><p>SyntaxError: 语法错误</p><div class="language-js"><pre><code><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span>
<span class="token punctuation">}</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>SyntaxError（语法错误）发生在代码解析过程中，一般在开发阶段就会发现</p></li><li><p>TypeError: 类型错误</p><div class="language-js"><pre><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">123</span>
a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre></div><p>TypeError (类型错误) 是变量不是预期的类型时发生错误</p></li><li><p>RangeError: 范围错误</p><div class="language-js"><pre><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>RangeError (范围错误) 是一个值超过了有效的范围时发生错误</p></li><li><p>ReferenceError: 引用错误</p><div class="language-js"><pre><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aaa<span class="token punctuation">)</span>
</code></pre></div><p>ReferenceError (引用错误) 是引用一个不存在的变量时发生错误</p></li></ul><ul><li><p>Failed to load resource: 资源加载错误</p><p>资源加载错误是指以下标签加载资源出错时发生错误</p><div class="language-"><pre><code>&lt;img&gt;, &lt;input type=&quot;image&quot;&gt;, &lt;object&gt;, &lt;script&gt;, &lt;style&gt;, &lt;audio&gt;, &lt;video&gt;
</code></pre></div></li></ul><p>如何收集报错信息，有两种方案: 通过 <code>try...catch...</code> 捕获，以及 <code>window.onerror</code> 监听</p><ul><li><p><code>try...catch...</code> 方案</p><div class="language-js"><pre><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 代码</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 错误处理</span>
  <span class="token comment">// 上报错误</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过自动化工具可对每个函数添加 try catch, 对错误进行<strong>兜底处理</strong>，但也存在局限性</p><ul><li>无法处理语法错误和异步错误</li></ul><div class="language-js"><pre><code><span class="token comment">// 下面两种报错信息，try...catch 都无法捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span>\ <span class="token string">&#39;a&#39;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>对代码的侵入性较强</li></ul></li><li><p><code>window.onerror</code> 方案</p><p>使用 <code>window.onerror</code> 监听也存在局限性，因为 <code>window.onerror</code> 是通过<strong>事件冒泡</strong>获取 error 信息，而网络资源加载错误是不会进行冒泡的，而 <code>window.addEventListener</code> 是通过<strong>事件捕获</strong>获取 error 信息的，</p><p>同时 <code>window.onerror</code> 可以通过赋值进行覆盖掉，而 <code>addEventListener</code> 可以绑定多个回调，所以最终使用 <code>addEventListener</code> 统一对 JS 错误和资源加载错误进行收集</p><div class="language-js"><pre><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> handlerError<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div></li></ul><p>除了上面的报错，我们还需要捕获未处理的 <code>Promise</code> 错误，可通过绑定 <code>unhandledrejection</code> 事件来监听</p><div class="language-js"><pre><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;unhandledrejection&#39;</span><span class="token punctuation">,</span> handlerError<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>而针对于 React 和 Vue 框架中的保持，以 Vue 为例，官方提供<code>Vue.config.errorHandler</code> 来处理捕获的错误，如何开发者没配置，捕获的错误会以 <code>console.error</code> 的方式输出，所以可以劫持 <code>console.error</code> 来捕获框架中的错误</p><div class="language-js"><pre><code>console<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> errorLog <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;xxx&#39;</span><span class="token punctuation">,</span>
      desc<span class="token operator">:</span> info<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token function">handlerError</span><span class="token punctuation">(</span>errorLog<span class="token punctuation">)</span> <span class="token comment">// 进行上报</span>
    <span class="token function">origin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
</code></pre></div><h4 id="_2-1-2、性能相关数据"><a class="header-anchor" href="#_2-1-2、性能相关数据" aria-hidden="true">#</a> 2.1.2、性能相关数据</h4><p>性能监控常用指标</p><ul><li>首次绘制时间（FP）：页面发生第一次绘制的时间点</li><li>首次有内容绘制时间（FCP）：浏览器完成渲染 DOM 中第一部分内容的时间点</li><li>首次有意义绘制时间（FMP）：页面关键元素的渲染时间，何为“关键元素”可自行定义</li><li>首屏时间：进入页面之后，应用渲染完成整个屏幕(未滚动)内容的时间</li><li>用户可交互时间：通常指 <code>DOMReady</code> 时间</li><li>总下载时间: 可统计称 <code>window.onload</code> 时间</li></ul><p>以上指标可在浏览器控制台中通过 <code>Lighthouse</code> 进行分析得出,也可通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver" target="_blank" rel="noopener noreferrer">PerformanceObserver</a> 来获取, 具体代码可参考 <a href="https://juejin.cn/post/7017974567943536671#heading-1" target="_blank" rel="noopener noreferrer">SDK-性能数据采集</a></p><p>性能数据获取</p><ul><li><code>window.preformance</code>：强大有缺点</li></ul><p><code>window.preformance.timing</code> 会返回一个对象，包含页面加载和渲染的各个时间节点</p><p><img src="/portal-blog/images/sdk/timing.png" alt="linear.png"></p><p>而根据这些时间节点选择相对于的两个做差值，即可计算出一些典型指标</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">calcTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> window<span class="token punctuation">.</span>preformance<span class="token punctuation">.</span>timing

  <span class="token comment">// 重定向时间</span>
  times<span class="token punctuation">.</span>redirectTime <span class="token operator">=</span> t<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>redirectStart
  <span class="token comment">// DNS 查询耗时</span>
  times<span class="token punctuation">.</span>dnsTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>domainLookupStart
  <span class="token comment">// TCP 连接耗时</span>
  times<span class="token punctuation">.</span>tcpTime <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
  <span class="token comment">// request 请求耗时</span>
  times<span class="token punctuation">.</span>reqTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> t<span class="token punctuation">.</span>requestStart
  <span class="token comment">// response 响应耗时</span>
  times<span class="token punctuation">.</span>resTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>responseStart
  <span class="token comment">// 解析 DOM 树耗时</span>
  times<span class="token punctuation">.</span>analysisTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> t<span class="token punctuation">.</span>domInteractive
  <span class="token comment">// 白屏时间</span>
  times<span class="token punctuation">.</span>blackTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
  <span class="token comment">// 用户可交互时间</span>
  times<span class="token punctuation">.</span>domReadyTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domContentLoadedEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
  <span class="token comment">// 页面完全可用时间</span>
  times<span class="token punctuation">.</span>loadPageTime <span class="token operator">=</span> t<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart

  <span class="token keyword">return</span> times
<span class="token punctuation">}</span>
</code></pre></div><p>局限性</p><p>单页应用改变 URL 但不刷新页面，导致 <code>window.preformance</code> 所获取的数据不会更新</p><ul><li>自定义时间计算</li></ul><div class="language-"><pre><code>// [todo]
</code></pre></div><h3 id="_2-2、手动上报数据"><a class="header-anchor" href="#_2-2、手动上报数据" aria-hidden="true">#</a> 2.2、手动上报数据</h3><p>手动上报数据适合用户行为收集、自定义错误收集等场景，只需要将手动上报数据的方法暴露出去即可</p><h3 id="_2-3、何时上报以及如何上报"><a class="header-anchor" href="#_2-3、何时上报以及如何上报" aria-hidden="true">#</a> 2.3、何时上报以及如何上报</h3><p>对应报错和异常数据的上报，当日志量很大，就有必要将日志合并，在同一时间进行上报。</p><p>而对于页面性能数据，在以下场景下可以上报</p><ul><li>页面加载和重新刷新</li><li>页面切换路由</li><li>页面所在的 Tab 标签重新变得可见</li><li>页面关闭</li></ul><p>对于单页应用，如果是 hash 模式，可监听 <code>hashchange</code> 事件, 如果是 <code>history</code> 模式，则需要重写 <code>history.pushState</code> 和 <code>history.replaceState</code> 方法</p><p>对于非单页应用，可在页面离开的时候上报数据，监听 <code>unload</code> 事件并使用 <code>navigation.sendBeacon</code> 方法保障数据发送</p><div class="language-js"><pre><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;unload&#39;</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">logData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  navigation<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">&#39;/log&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>sendBeacon</code> 方法相比于直接发送 Ajax 请求，有以下优势</p><ul><li>它是异步的，请求的发送不会阻塞跳转到下一个页面</li><li>它在没有极限数据量和队列总数的现在下，会优先返回 true 以保障请求成功发送</li></ul><p>除了发送请求，还可以通过动态创建 img 标签，将数据拼接到 URL 上进行上报，不存在跨域限制，但 URL 有长度限制</p><p>所以可以对 URL 进行判断，使用不同上报方式</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">reportLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>urlLen <span class="token operator">&lt;</span> <span class="token number">2083</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">imgReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> times<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>navigation<span class="token punctuation">.</span>sendBeacon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> times<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">xmlReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> times<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、总结"><a class="header-anchor" href="#三、总结" aria-hidden="true">#</a> 三、总结</h2><p>SDK 除了上面介绍的数据采集和上报功能后，还需要提供通过<strong>配置</strong>可开启或关闭某个指标的日志是否进行上报</p><p>参考资料</p><ul><li><a href="https://zhuanlan.zhihu.com/p/95384915" target="_blank" rel="noopener noreferrer">从零开始搭建前端监控 - 陈辰</a></li><li><a href="https://juejin.cn/post/7017974567943536671#heading-13" target="_blank" rel="noopener noreferrer">前端监控 SDK 的一些技术要点原理分析</a></li><li><a href="https://item.jd.com/10022900825335.html" target="_blank" rel="noopener noreferrer">性能监控和错误收集与上报</a></li></ul></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/portal-blog/source-analysis/Webpack/1、如何调试Webpack源码" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>1、如何调试Webpack源码</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/portal-blog/source-analysis/前端运维/1、Linux 命令汇总" data-v-38ede35f><span class="text" data-v-38ede35f>1、Linux 命令汇总</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"0a5e016b\",\"frontend-graph_readme.md\":\"621c798b\",\"project-develop_readme.md\":\"e9087d4a\",\"project-develop_index.md\":\"904b8ea7\",\"source-analysis_readme.md\":\"aef0402d\",\"frontend-graph_css_1、页面布局原理.md\":\"d08dacaf\",\"frontend-graph_css_2、常见的页面布局及技巧.md\":\"2aae6fa7\",\"frontend-graph_css_3、一文汇总元素居中的9种办法.md\":\"c997cefa\",\"frontend-graph_css_4、css中的动画.md\":\"e26640ec\",\"frontend-graph_css_5、面试题汇总.md\":\"e82f76ae\",\"frontend-graph_css_6、css资源汇总.md\":\"7435ec57\",\"frontend-graph_html_2、移动端h5\\\"踩坑\\\"总结.md\":\"148b3f3d\",\"frontend-graph_html_3、浏览器解析html流程.md\":\"99771a56\",\"frontend-graph_javascript_1、js中的基础知识.md\":\"fd3c22e0\",\"frontend-graph_javascript_2、面向对象和原型.md\":\"c406a60a\",\"frontend-graph_javascript_3、js中的this和闭包.md\":\"263342e2\",\"frontend-graph_javascript_4、js代码执行机制.md\":\"ac8f9753\",\"frontend-graph_javascript_5、js中的异步.md\":\"7d11f09e\",\"frontend-graph_javascript_6、手写promise汇总.md\":\"e9e4b2aa\",\"frontend-graph_javascript_7、30个api手写实现.md\":\"fddfb772\",\"frontend-graph_javascript_8、高频面试题汇总.md\":\"e6382fd0\",\"frontend-graph_vue_1、vue面试题汇总.md\":\"4bb1b869\",\"frontend-graph_工程化_1、模块化机制.md\":\"ae32da59\",\"frontend-graph_工程化_2、webpack 工作流程.md\":\"68fb970c\",\"frontend-graph_工程化_3、webpack loader机制.md\":\"960ef4b6\",\"frontend-graph_工程化_4、webpack plugin机制.md\":\"04deb510\",\"frontend-graph_工程化_5、webpack 优化策略.md\":\"d9c7a209\",\"frontend-graph_浏览器_1、浏览器缓存.md\":\"27f58e8f\",\"frontend-graph_浏览器_2、浏览器架构.md\":\"52353ce5\",\"frontend-graph_浏览器_3、浏览器的工作原理.md\":\"57efe67f\",\"frontend-graph_浏览器_4、一文汇总9种跨域方法.md\":\"7f0d5476\",\"frontend-graph_浏览器_5、全面总结web性能优化.md\":\"4828d372\",\"frontend-graph_浏览器_6、浏览器中的网络.md\":\"80562c66\",\"frontend-graph_浏览器_7、浏览器安全.md\":\"f8e50764\",\"project-develop_vue_vue3 + vite 搭建ui组件库.md\":\"d4c53512\",\"source-analysis_visualization_1、线性代数的本质-学习笔记.md\":\"7a58fd43\",\"source-analysis_vue2.x源码_1、第一篇｜变化侦测.md\":\"83138a68\",\"source-analysis_webpack_1、如何调试webpack源码.md\":\"7454d69d\",\"source-analysis_前端监控系统_1、数据采集与上报之sdk.md\":\"75ecf6e4\",\"source-analysis_前端运维_1、linux 命令汇总.md\":\"01de0228\",\"source-analysis_前端运维_2、vim命令汇总.md\":\"ebca9085\",\"source-analysis_前端运维_3、文件权限.md\":\"3751a5b6\",\"source-analysis_前端运维_4、nginx学习.md\":\"a26987dd\"}")</script>
    <script type="module" async src="/portal-blog/assets/app.5a70c45b.js"></script>
  </body>
</html>