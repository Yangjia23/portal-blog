import{o as n,c as s,a,b as t}from"./app.5c37ca96.js";const o='{"title":"一、对 Object 的监测","description":"","frontmatter":{},"headers":[{"level":2,"title":"一、对 Object 的监测","slug":"一、对-object-的监测"},{"level":3,"title":"1.1、如何收集依赖？","slug":"_1-1、如何收集依赖？"},{"level":3,"title":"1.2、收集的依赖存在哪？","slug":"_1-2、收集的依赖存在哪？"},{"level":3,"title":"1.3、依赖为何物？","slug":"_1-3、依赖为何物？"},{"level":3,"title":"1.4、监测所有的 key","slug":"_1-4、监测所有的-key"},{"level":3,"title":"1.5、局限性","slug":"_1-5、局限性"},{"level":3,"title":"1.6、小结","slug":"_1-6、小结"},{"level":2,"title":"二、对 Array 的监测","slug":"二、对-array-的监测"},{"level":3,"title":"2.1、拦截器","slug":"_2-1、拦截器"},{"level":3,"title":"2.2、如何收集依赖？","slug":"_2-2、如何收集依赖？"},{"level":3,"title":"2.3、存储依赖","slug":"_2-3、存储依赖"},{"level":3,"title":"2.4、收集依赖","slug":"_2-4、收集依赖"},{"level":3,"title":"2.5、通知依赖","slug":"_2-5、通知依赖"},{"level":3,"title":"2.6、局限性","slug":"_2-6、局限性"}],"relativePath":"source-analysis/Vue2.x源码/1、第一篇｜变化侦测.md","lastUpdated":1633751698596}',e={},c=[a("p",null,[t("这是 Vue2.x 源码分析的第一篇，介绍在 vue.js 中如何对 "),a("code",null,"Object"),t(" 和 "),a("code",null,"Array"),t(" 进行变化侦测的")],-1),a("p",null,"Vue.js 的渲染过程是声明式的，当内部的状态发生了变化，需要不断进行重新渲染，变化侦测就是来监听内部状态的变化。",-1),a("h2",{id:"一、对-object-的监测"},[a("a",{class:"header-anchor",href:"#一、对-object-的监测","aria-hidden":"true"},"#"),t(" 一、对 Object 的监测")],-1),a("p",null,[t("在 JS 中可以使用 "),a("code",null,"Object.defineProperty"),t(" 和 "),a("code",null,"Proxy"),t(" 这两个方法来监测变化，Vue 2.x 版本考虑到兼容性使用的是 "),a("code",null,"Object.defineProperty"),t(" 方法，而在 Vue 3.x 中使用的是 "),a("code",null,"Proxy"),t("，后续介绍")],-1),a("p",null,[t("在 Vue 源码中，对 "),a("code",null,"Object.defineProperty"),t(" 封装如下")],-1),a("div",{class:"language-js"},[a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"defineReactive"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(" val")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n  Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"defineProperty"),a("span",{class:"token punctuation"},"("),t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token punctuation"},"{"),t("\n    enumerable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    configurable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"get"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveGetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"return"),t(" value\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"set"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveSetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"newVal"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("newVal "),a("span",{class:"token operator"},"==="),t(" val"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n        "),a("span",{class:"token keyword"},"return"),t("\n      "),a("span",{class:"token punctuation"},"}"),t("\n      val "),a("span",{class:"token operator"},"="),t(" newVal\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("所以，当从"),a("code",null,"data"),t("的"),a("code",null,"key"),t("中读取数据时，"),a("code",null,"get"),t("函数被触发；当往"),a("code",null,"data"),t("的"),a("code",null,"key"),t("中设置数据，"),a("code",null,"set"),t("函数被触发")],-1),a("h3",{id:"_1-1、如何收集依赖？"},[a("a",{class:"header-anchor",href:"#_1-1、如何收集依赖？","aria-hidden":"true"},"#"),t(" 1.1、如何收集依赖？")],-1),a("p",null,[t("在上面使用 "),a("code",null,"Object.defineProperty"),t(" 对数据监测，是因为当数据发生变化的时候，需要通知到那些使用到该数据的地方，例如👇")],-1),a("div",{class:"language-html"},[a("pre",null,[a("code",null,[a("span",{class:"token tag"},[a("span",{class:"token tag"},[a("span",{class:"token punctuation"},"<"),t("template")]),a("span",{class:"token punctuation"},">")]),t("\n  "),a("span",{class:"token tag"},[a("span",{class:"token tag"},[a("span",{class:"token punctuation"},"<"),t("div")]),a("span",{class:"token punctuation"},">")]),t("{{ title }}"),a("span",{class:"token tag"},[a("span",{class:"token tag"},[a("span",{class:"token punctuation"},"<"),t("div")]),a("span",{class:"token punctuation"},">")]),t("\n"),a("span",{class:"token tag"},[a("span",{class:"token tag"},[a("span",{class:"token punctuation"},"</"),t("template")]),a("span",{class:"token punctuation"},">")]),t("\n")])])],-1),a("p",null,[t("在组件的 "),a("code",null,"tempalte"),t(" 中使用来数据 "),a("code",null,"title"),t(", 所以当 "),a("code",null,"title"),t(" 变化了，需要通知到 "),a("code",null,"tempalte")],-1),a("p",null,[t("总结就是："),a("strong",null,[t("在"),a("code",null,"getter"),t("中收集依赖，在"),a("code",null,"setter"),t("中触发(通知)依赖")])],-1),a("h3",{id:"_1-2、收集的依赖存在哪？"},[a("a",{class:"header-anchor",href:"#_1-2、收集的依赖存在哪？","aria-hidden":"true"},"#"),t(" 1.2、收集的依赖存在哪？")],-1),a("p",null,[t("在 Vue 源码中，使用了一个 "),a("code",null,"Dep"),t(" 类来封装依赖收集的代码，通过这个类，可以"),a("strong",null,"收集依赖"),t("、"),a("strong",null,"删除依赖"),t("或者"),a("strong",null,"向依赖发通知")],-1),a("div",{class:"language-js"},[a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/dep.js\n*/"),t("\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"default"),t(),a("span",{class:"token keyword"},"class"),t(),a("span",{class:"token class-name"},"Dep"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token function"},"constructor"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token comment"},"// 用了存储依赖"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("subs "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token punctuation"},"["),a("span",{class:"token punctuation"},"]"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"addSub"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"sub"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("subs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"push"),a("span",{class:"token punctuation"},"("),t("sub"),a("span",{class:"token punctuation"},")"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"removeSub"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"sub"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token function"},"remove"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("subs"),a("span",{class:"token punctuation"},","),t(" sub"),a("span",{class:"token punctuation"},")"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"depend"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("window"),a("span",{class:"token punctuation"},"."),t("target"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"addSub"),a("span",{class:"token punctuation"},"("),t("window"),a("span",{class:"token punctuation"},"."),t("target"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"notify"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" subs "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("subs"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"slice"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"for"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"let"),t(" i "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},","),t(" l "),a("span",{class:"token operator"},"="),t(" subs"),a("span",{class:"token punctuation"},"."),t("length"),a("span",{class:"token punctuation"},";"),t(" i "),a("span",{class:"token operator"},"<"),t(" l"),a("span",{class:"token punctuation"},";"),t(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      subs"),a("span",{class:"token punctuation"},"["),t("i"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"update"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("在 "),a("code",null,"defineReactive"),t(" 函数中，就可以使用 Dep 类了")],-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"defineReactive"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(" val")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token comment"},"// 1、每个 key 都创建一个实例来存储该属性的依赖"),t("\n  "),a("span",{class:"token keyword"},"const"),t(" dep "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"Dep"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n  Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"defineProperty"),a("span",{class:"token punctuation"},"("),t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token punctuation"},"{"),t("\n    enumerable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    configurable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"get"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveGetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token comment"},"// 2、当获取属性时，收集依赖"),t("\n      dep"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"depend"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n      "),a("span",{class:"token keyword"},"return"),t(" value\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"set"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveSetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"newVal"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("newVal "),a("span",{class:"token operator"},"==="),t(" val"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n        "),a("span",{class:"token keyword"},"return"),t("\n      "),a("span",{class:"token punctuation"},"}"),t("\n      val "),a("span",{class:"token operator"},"="),t(" newVal\n      "),a("span",{class:"token comment"},"// 3、当属性发生变化，通知依赖"),t("\n      dep"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"notify"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("在收集依赖前，我们假设了依赖保存在 "),a("code",null,"window.target"),t(" 上了。此时，我们知道了收集的依赖是存储到 "),a("code",null,"Dep"),t(" 中的")],-1),a("h3",{id:"_1-3、依赖为何物？"},[a("a",{class:"header-anchor",href:"#_1-3、依赖为何物？","aria-hidden":"true"},"#"),t(" 1.3、依赖为何物？")],-1),a("p",null,[t("依赖，也就是使用到数据的地方，同时也是数据发生变化时，需要通知到的地方。以 "),a("code",null,"data"),t(" 中的数据为例，在 "),a("code",null,"template"),t("、"),a("code",null,"computed"),t("、"),a("code",null,"watch"),t(" 等多个地方都可以使用到，所以，Vue.js 内部抽象出一个能集中处理这些情况的类，收集依赖时，只需要收集这个类的实例，同时通知也只需要通知到它一个，它再通知到其他地方，这个类叫做 "),a("strong",null,"Watcher")],-1),a("p",null,[t("所以，收集依赖，就是收集 "),a("strong",null,"Watcher"),t(" 实例")],-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/watcher.js\n*/"),t("\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"class"),t(),a("span",{class:"token class-name"},"Watcher"),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token function"},"constructor"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("vm"),a("span",{class:"token punctuation"},","),t(" expOrFn"),a("span",{class:"token punctuation"},","),t(" cb")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("vm "),a("span",{class:"token operator"},"="),t(" vm\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("getter "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token function"},"parsePath"),a("span",{class:"token punctuation"},"("),t("expOrFn"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("cb "),a("span",{class:"token operator"},"="),t(" cb\n    "),a("span",{class:"token comment"},"// 1、初始化，调用 this.get() => this.getter()"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"get"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token function"},"get"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token comment"},"// 2、当前 Watcher 实例保存在 window.target 上"),t("\n    window"),a("span",{class:"token punctuation"},"."),t("target "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),t("\n    "),a("span",{class:"token keyword"},"let"),t(" value "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getter"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"call"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("vm"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("vm"),a("span",{class:"token punctuation"},")"),t("\n    window"),a("span",{class:"token punctuation"},"."),t("target "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"undefined"),t("\n    "),a("span",{class:"token keyword"},"return"),t(" value\n  "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token function"},"update"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token comment"},"// 3、属性变化，通知依赖会调用 update 方法, 再去执行回调函数cb"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" oldValue "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"get"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"cb"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"call"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("vm"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value"),a("span",{class:"token punctuation"},","),t(" oldValue"),a("span",{class:"token punctuation"},")"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("所以，无论是 "),a("code",null,"vm.$watch('obj.name',(value, oldValue) => {})"),t(" 还是模版中使用"),a("code",null,"obj.name"),t(", 当数据发生变化时，都需要通过 "),a("code",null,"Watcher"),t(" 来进行通知，执行各种的回调函数")],-1),a("h3",{id:"_1-4、监测所有的-key"},[a("a",{class:"header-anchor",href:"#_1-4、监测所有的-key","aria-hidden":"true"},"#"),t(" 1.4、监测所有的 key")],-1),a("p",null,[a("code",null,"defineReactive"),t(" 方法是监测数据中的单个属性，而我们需要监测到所有的属性（包括子属性），将其都转换成 "),a("code",null,"getter/setter"),t(" 的形式")],-1),a("div",{class:"language-js"},[a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"class"),t(),a("span",{class:"token class-name"},"Observer"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token function"},"constructor"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("value"),a("span",{class:"token operator"},":"),t(" any")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value "),a("span",{class:"token operator"},"="),t(" value\n    "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token operator"},"!"),t("Array"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"isArray"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"walk"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"walk"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("obj"),a("span",{class:"token operator"},":"),t(" Object")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" keys "),a("span",{class:"token operator"},"="),t(" Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"keys"),a("span",{class:"token punctuation"},"("),t("obj"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"for"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"let"),t(" i "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},";"),t(" i "),a("span",{class:"token operator"},"<"),t(" keys"),a("span",{class:"token punctuation"},"."),t("length"),a("span",{class:"token punctuation"},";"),t(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token function"},"defineReactive"),a("span",{class:"token punctuation"},"("),t("obj"),a("span",{class:"token punctuation"},","),t(" keys"),a("span",{class:"token punctuation"},"["),t("i"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},","),t(" obj"),a("span",{class:"token punctuation"},"["),t("keys"),a("span",{class:"token punctuation"},"["),t("i"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n\n"),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"defineReactive"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(" val")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token comment"},"/*省略*/"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("h3",{id:"_1-5、局限性"},[a("a",{class:"header-anchor",href:"#_1-5、局限性","aria-hidden":"true"},"#"),t(" 1.5、局限性")],-1),a("p",null,[t("Vue.js 通过 "),a("code",null,"Object.defineProperty"),t(" 来将对象的 key 转换成 "),a("code",null,"getter/setter"),t(" 的形式来追踪变化，但 "),a("code",null,"getter/setter"),t(" 只能追踪一个数据是否被修改，无法追踪新增的属性已经删除的属性，为了解决这问题，Vue.js 提供了 "),a("strong",null,[a("code",null,"$set")]),t(" 和 "),a("strong",null,[a("code",null,"$delete")]),t(" 两个API")],-1),a("h3",{id:"_1-6、小结"},[a("a",{class:"header-anchor",href:"#_1-6、小结","aria-hidden":"true"},"#"),t(" 1.6、小结")],-1),a("p",null,"关于如何监测Object,汇总如下图👇",-1),a("p",null,[a("img",{src:"/portal-blog/images/vue/defineProperty.png",alt:"监测Object"})],-1),a("h2",{id:"二、对-array-的监测"},[a("a",{class:"header-anchor",href:"#二、对-array-的监测","aria-hidden":"true"},"#"),t(" 二、对 Array 的监测")],-1),a("p",null,[t("对 Array 的监测不能使用 "),a("code",null,"getter/setter"),t(" 方法，是因为我们常通过 Array 原型上的方法来改变数组的内容")],-1),a("p",null,[t("通过汇总，Array 原型上可以改变数组自身内容的方法共 7 个，分别是："),a("code",null,"push"),t(", "),a("code",null,"pop"),t(", "),a("code",null,"shift"),t(", "),a("code",null,"unshift"),t(", "),a("code",null,"slice"),t(", "),a("code",null,"sort"),t(", "),a("code",null,"reverse")],-1),a("h3",{id:"_2-1、拦截器"},[a("a",{class:"header-anchor",href:"#_2-1、拦截器","aria-hidden":"true"},"#"),t(" 2.1、拦截器")],-1),a("p",null,"想要监测数组的变化，只需用一个拦截器覆盖 Array原型，当使用上述 7 种方法修改数组时，执行的时拦截器中的方法",-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/array.js\n*/"),t("\n"),a("span",{class:"token keyword"},"import"),t(),a("span",{class:"token punctuation"},"{"),t(" def "),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"from"),t(),a("span",{class:"token string"},"'../util/index'"),t("\n"),a("span",{class:"token comment"},"// 1、基于 Array.prototype 创建一个拦截器"),t("\n"),a("span",{class:"token keyword"},"const"),t(" arrayProto "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token class-name"},"Array"),a("span",{class:"token punctuation"},"."),t("prototype\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"const"),t(" arrayMethods "),a("span",{class:"token operator"},"="),t(" Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"create"),a("span",{class:"token punctuation"},"("),t("arrayProto"),a("span",{class:"token punctuation"},")"),t("\n\n"),a("span",{class:"token keyword"},"const"),t(" methodsToPatch "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token punctuation"},"["),t("\n  "),a("span",{class:"token string"},"'push'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'pop'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'shift'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'unshift'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'splice'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'sort'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'reverse'"),t("\n"),a("span",{class:"token punctuation"},"]"),t("\n\nmethodsToPatch"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"forEach"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"method"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token keyword"},"const"),t(" original "),a("span",{class:"token operator"},"="),t(" arrayProto"),a("span",{class:"token punctuation"},"["),t("method"),a("span",{class:"token punctuation"},"]"),t("\n  "),a("span",{class:"token comment"},"// 2、在拦截器上重新定义上述 7 个方法"),t("\n  "),a("span",{class:"token function"},"def"),a("span",{class:"token punctuation"},"("),t("arrayMethods"),a("span",{class:"token punctuation"},","),t(" method"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"mutator"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[a("span",{class:"token operator"},"..."),t("args")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token comment"},"// 3、执行方法本身的逻辑，返回执行结果"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" result "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token function"},"original"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"apply"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},","),t(" args"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"return"),t(" result\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n\n")])])],-1),a("h3",{id:"_2-2、如何收集依赖？"},[a("a",{class:"header-anchor",href:"#_2-2、如何收集依赖？","aria-hidden":"true"},"#"),t(" 2.2、如何收集依赖？")],-1),a("p",null,"对数组而言，通知依赖肯定是在拦截器中，那么，数组在哪里收集依赖呢？看个例子",-1),a("div",{class:"language-js"},[a("pre",null,[a("code",null,[a("span",{class:"token punctuation"},"{"),t("\n  list"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token punctuation"},"["),a("span",{class:"token number"},"1"),a("span",{class:"token punctuation"},","),a("span",{class:"token number"},"2"),a("span",{class:"token punctuation"},","),a("span",{class:"token number"},"3"),a("span",{class:"token punctuation"},"]"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("以上面数据为例，只有通过 "),a("code",null,"list"),t(" 属性，才能获取这个数组，那么读取 "),a("code",null,"list"),t(" 属性，一定为触发"),a("code",null,"list"),t("属性的 "),a("code",null,"getter"),t(" 方法，所以数组也是在 "),a("code",null,"getter"),t(" 中收集依赖")],-1),a("p",null,[t("所以，"),a("strong",null,"Array 在 getter 中收集依赖，在拦截器中触发(通知)依赖")],-1),a("h3",{id:"_2-3、存储依赖"},[a("a",{class:"header-anchor",href:"#_2-3、存储依赖","aria-hidden":"true"},"#"),t(" 2.3、存储依赖")],-1),a("p",null,"Array 的依赖也是通过 Dep 实例来进行保存，但与 Object 不同的是，Vue.js 把 Array 的 dep 放到 Observer 中了，而对象属性对应的 dep 则在 defineReactive 函数中",-1),a("p",null,"之所以放在 Observer 中, 是因为在 getter 和拦截器中都需要访问到这个 dep 实例",-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("br"),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"class"),t(),a("span",{class:"token class-name"},"Observer"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token function"},"constructor"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("value"),a("span",{class:"token operator"},":"),t(" any")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value "),a("span",{class:"token operator"},"="),t(" value\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("dep "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"Dep"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("Array"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"isArray"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"observeArray"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t(" \n    "),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"else"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"walk"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n\n  "),a("span",{class:"token function"},"observeArray"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("items"),a("span",{class:"token operator"},":"),t(" Array"),a("span",{class:"token operator"},"<"),t("any"),a("span",{class:"token operator"},">")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"for"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"let"),t(" i "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},","),t(" l "),a("span",{class:"token operator"},"="),t(" items"),a("span",{class:"token punctuation"},"."),t("length"),a("span",{class:"token punctuation"},";"),t(" i "),a("span",{class:"token operator"},"<"),t(" l"),a("span",{class:"token punctuation"},";"),t(" i"),a("span",{class:"token operator"},"++"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token comment"},"// 2、可能是对象数组，需要监测数组每一项"),t("\n      "),a("span",{class:"token function"},"observe"),a("span",{class:"token punctuation"},"("),t("items"),a("span",{class:"token punctuation"},"["),t("i"),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("h3",{id:"_2-4、收集依赖"},[a("a",{class:"header-anchor",href:"#_2-4、收集依赖","aria-hidden":"true"},"#"),t(" 2.4、收集依赖")],-1),a("p",null,"我们需要在 getter 中访问到 dep 实例，才能收集依赖，代码如下",-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"defineReactive"),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(" val")]),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token comment"},"// 1、此处假设 val 是个数组"),t("\n  "),a("span",{class:"token keyword"},"let"),t(" childOb "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token function"},"observer"),a("span",{class:"token punctuation"},"("),t("val"),a("span",{class:"token punctuation"},")"),t("\n  Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"defineProperty"),a("span",{class:"token punctuation"},"("),t("obj"),a("span",{class:"token punctuation"},","),t(" key"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token punctuation"},"{"),t("\n    enumerable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    configurable"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token boolean"},"true"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"get"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveGetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token comment"},"// 2、收集依赖"),t("\n      "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("childOb"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n        childOb"),a("span",{class:"token punctuation"},"."),t("dep"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"depend"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n      "),a("span",{class:"token punctuation"},"}"),t("\n      "),a("span",{class:"token keyword"},"return"),t(" value\n    "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},","),t("\n    "),a("span",{class:"token function-variable function"},"set"),a("span",{class:"token operator"},":"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"reactiveSetter"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"newVal"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("newVal "),a("span",{class:"token operator"},"==="),t(" val"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n        "),a("span",{class:"token keyword"},"return"),t("\n      "),a("span",{class:"token punctuation"},"}"),t("\n      val "),a("span",{class:"token operator"},"="),t(" newVal\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"observe"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"value"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token operator"},"!"),a("span",{class:"token function"},"isObject"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token operator"},"||"),t(" value "),a("span",{class:"token keyword"},"instanceof"),t(),a("span",{class:"token class-name"},"VNode"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"return"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token keyword"},"let"),t(" ob"),a("span",{class:"token operator"},":"),t(" Observer "),a("span",{class:"token operator"},"|"),t(),a("span",{class:"token keyword"},"void"),t("\n  "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token function"},"hasOwn"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token string"},"'__ob__'"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token operator"},"&&"),t(" value"),a("span",{class:"token punctuation"},"."),t("__ob__ "),a("span",{class:"token keyword"},"instanceof"),t(),a("span",{class:"token class-name"},"Observer"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    ob "),a("span",{class:"token operator"},"="),t(" value"),a("span",{class:"token punctuation"},"."),t("__ob__ "),a("span",{class:"token comment"},"// 当数据已经检测过，直接返回"),t("\n  "),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"else"),t(),a("span",{class:"token punctuation"},"{"),t("\n    ob "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"Observer"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token comment"},"// 进行检测"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token keyword"},"return"),t(" ob\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("以数据 "),a("code",null,"list: [1,2,3]"),t(" 为例，当访问属性 list, 会对数组 "),a("code",null,"[1,2,3]"),t(" 进行监测")],-1),a("h3",{id:"_2-5、通知依赖"},[a("a",{class:"header-anchor",href:"#_2-5、通知依赖","aria-hidden":"true"},"#"),t(" 2.5、通知依赖")],-1),a("p",null,"Array 发生变化时，需要在拦截器中访问到 Observer 实例，通过其 dep 属性通知依赖",-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/index.js\n*/"),t("\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"class"),t(),a("span",{class:"token class-name"},"Observer"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token function"},"constructor"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[t("value"),a("span",{class:"token operator"},":"),t(" any")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("value "),a("span",{class:"token operator"},"="),t(" value\n    "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("dep "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"Dep"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token function"},"def"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token string"},"'__ob__'"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("Array"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"isArray"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"observeArray"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t(" \n    "),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"else"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"walk"),a("span",{class:"token punctuation"},"("),t("value"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token comment"},"//..."),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),a("p",null,[t("在 "),a("code",null,"value"),t(" 上增加 "),a("code",null,"__ob__"),t(" 属性即可访问到 "),a("code",null,"Observer"),t(" 实例，继而可以访问 "),a("code",null,"dep"),t(" 属性")],-1),a("p",null,[t("接下来，只需要在拦截器中通知依赖, 同时，当我们使用 "),a("code",null,"push"),t(", "),a("code",null,"unshift"),t(", "),a("code",null,"splice"),t(" 时会往数组中添加新元素，新增的元素也需要被监测到。")],-1),a("div",{class:"language-js"},[a("div",{class:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("div",{class:"highlighted"}," "),a("br"),a("br"),a("br"),a("br")]),a("pre",null,[a("code",null,[a("span",{class:"token comment"},"/*\n@filePath: src/core/observer/array.js\n*/"),t("\n"),a("span",{class:"token keyword"},"import"),t(),a("span",{class:"token punctuation"},"{"),t(" def "),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"from"),t(),a("span",{class:"token string"},"'../util/index'"),t("\n"),a("span",{class:"token keyword"},"const"),t(" arrayProto "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token class-name"},"Array"),a("span",{class:"token punctuation"},"."),t("prototype\n"),a("span",{class:"token keyword"},"export"),t(),a("span",{class:"token keyword"},"const"),t(" arrayMethods "),a("span",{class:"token operator"},"="),t(" Object"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"create"),a("span",{class:"token punctuation"},"("),t("arrayProto"),a("span",{class:"token punctuation"},")"),t("\n\n"),a("span",{class:"token keyword"},"const"),t(" methodsToPatch "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token punctuation"},"["),t("\n  "),a("span",{class:"token string"},"'push'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'pop'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'shift'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'unshift'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'splice'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'sort'"),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token string"},"'reverse'"),t("\n"),a("span",{class:"token punctuation"},"]"),t("\n\nmethodsToPatch"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"forEach"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},"method"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token keyword"},"const"),t(" original "),a("span",{class:"token operator"},"="),t(" arrayProto"),a("span",{class:"token punctuation"},"["),t("method"),a("span",{class:"token punctuation"},"]"),t("\n  "),a("span",{class:"token function"},"def"),a("span",{class:"token punctuation"},"("),t("arrayMethods"),a("span",{class:"token punctuation"},","),t(" method"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token keyword"},"function"),t(),a("span",{class:"token function"},"mutator"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token parameter"},[a("span",{class:"token operator"},"..."),t("args")]),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" result "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token function"},"original"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"apply"),a("span",{class:"token punctuation"},"("),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},","),t(" args"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"const"),t(" ob "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"this"),a("span",{class:"token punctuation"},"."),t("__ob__\n    "),a("span",{class:"token keyword"},"let"),t(" inserted\n    "),a("span",{class:"token keyword"},"switch"),t(),a("span",{class:"token punctuation"},"("),t("method"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token keyword"},"case"),t(),a("span",{class:"token string"},"'push'"),a("span",{class:"token operator"},":"),t("\n      "),a("span",{class:"token keyword"},"case"),t(),a("span",{class:"token string"},"'unshift'"),a("span",{class:"token operator"},":"),t("\n        inserted "),a("span",{class:"token operator"},"="),t(" args\n        "),a("span",{class:"token keyword"},"break"),t("\n      "),a("span",{class:"token keyword"},"case"),t(),a("span",{class:"token string"},"'splice'"),a("span",{class:"token operator"},":"),t("\n        inserted "),a("span",{class:"token operator"},"="),t(" args"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"slice"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"2"),a("span",{class:"token punctuation"},")"),t("\n        "),a("span",{class:"token keyword"},"break"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n    "),a("span",{class:"token keyword"},"if"),t(),a("span",{class:"token punctuation"},"("),t("inserted"),a("span",{class:"token punctuation"},")"),t(" ob"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"observeArray"),a("span",{class:"token punctuation"},"("),t("inserted"),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token comment"},"// notify change"),t("\n    ob"),a("span",{class:"token punctuation"},"."),t("dep"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"notify"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),t("\n    "),a("span",{class:"token keyword"},"return"),t(" result\n  "),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),a("span",{class:"token punctuation"},")"),t("\n")])])],-1),a("h3",{id:"_2-6、局限性"},[a("a",{class:"header-anchor",href:"#_2-6、局限性","aria-hidden":"true"},"#"),t(" 2.6、局限性")],-1),a("p",null,"通过 Array 下标修改元素的值，或者设置 list.length = 0 来清空数组等，Vue.js 都无法监测数组的变化",-1)];e.render=function(a,t,o,e,p,l){return n(),s("div",null,c)};export{o as __pageData,e as default};
