è¿™æ˜¯ Vue3.x æºç å®ç°çš„ç¬¬ä¸€ç¯‡ï¼Œä»‹ç» vue3 å¼€å‘ç¯å¢ƒçš„æ­å»ºå·¥ä½œ

## 1ã€é¡¹ç›®åˆå§‹åŒ–

```shell
mkdir mini-vue3-core
pnpm init -y
```

## 2ã€monorepo æ¶æ„

vue3 æºç é‡‡ç”¨ monorepo æ¶æ„ï¼Œåœ¨ä¸€ä¸ªä»“åº“é‡Œé¢ç®¡ç†å¤šä¸ªåŒ…ï¼Œæ¯ä¸ªåŒ…å¯ä½œä¸ºå•ç‹¬ä¾èµ–å­˜åœ¨

![margin-right](/images/vue3/vue3-core-part.png)

æ ¹ç›®å½•åˆ›å»º `pnpm-workspace.yaml` æ–‡ä»¶

```
packages:
  - 'packages/*'
```

## 3ã€å®‰è£…ä¾èµ–

```shell
pnpm install
typescript
rollup
rollup-plugin-typescript2
@rollup/plugin-json
@rollup/plugin-node-resolve
@rollup/plugin-commonjs
minimist
execa@4 -D -w
```

åˆ›å»º ts é…ç½®: `pnpm tsc --init`, ä¿®æ”¹é…ç½®å¦‚ä¸‹

```json
{
  "compilerOptions": {
    "outDir": "dist",
    "sourceMap": true,
    "target": "es2016", // ç›®æ ‡è¯­æ³•
    "module": "esnext", // æ¨¡å—æ ¼å¼
    "moduleResolution": "node", // æ¨¡å—è§£ææ–¹å¼
    "resolveJsonModule": true, // è§£æ json æ¨¡å—
    "esModuleInterop": true, // å…è®¸é€šè¿‡ es6 è¯­æ³•å¼•å…¥ commonjs æ¨¡å—
    "strict": false,
    "jsx": "preserve", // jsx ä¸è½¬è¯‘
    "lib": ["ESNext", "DOM"], // æ”¯æŒçš„ç±»åº“
    "baseUrl": ".",
    "paths": {
      "@vue/*": ["packages/*/src"]
    }
  }
}
```

## 4ã€åˆ›å»º reactivity ï¼Œ shared æ¨¡å—

æ¯ä¸ªæ¨¡å—éƒ½æ˜¯å•ç‹¬çš„ä¸€ä¸ªé¡¹ç›®

```json
// packages/reactivity/package.json
{
  "name": "@vue/reactivity",
  "version": "1.0.0",
  "main": "index.js",
  "module": "dist/reactivity.esm-bundler.js", // ç»™ webpack ä½¿ç”¨
  "upkg": "dist/reactivity.global.js", // å…¨å±€ä½¿ç”¨
  "buildOptions": {
    "name": "VueReactivity",
    "formats": ["esm-bundler", "cjs", "global"]
  }
}
```

```json
// packages/shared/package.json
{
  "name": "@vue/shared",
  "version": "1.0.0",
  "main": "index.js",
  "module": "dist/shared.esm-bundler.js",
  "buildOptions": {
    "formats": ["esm-bundler", "cjs"]
  }
}
```

æ¨¡å— `@vue/shared` ä¸­é›†æˆä¸€äº›å…¬å…±æ–¹æ³•ç­‰ï¼Œå¯åœ¨å…¶å®ƒæ¨¡å—ä¸­ä½¿ç”¨

```js
// packages/shared/src/index.ts
export function isObject(value: unknown) {
  return typeof value === 'object' && value !== null
}
```

æ¨¡å— `@vue/reactivity` ä¸­æƒ³è¦ä½¿ç”¨æ¨¡å— `@vue/shared` ä¸­å¯¼å‡ºçš„æ–¹æ³•å‰ï¼Œéœ€è¦å®‰è£… `@vue/shared` æ¨¡å—

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ

```shell
pnpm install @vue/shared@workspace --filter @vue/reactivity
```

- `@workspace`: æŒ‡å‘å½“å‰ç©ºé—´
- `--filter`: æŒ‡å®šå®‰è£…ç›®å½•

åœ¨ `@vue/reactivity` æ¨¡å—ä¸­ä¹‹é—´å¯¼å…¥å°±å¯ä»¥ä½¿ç”¨äº†

```
import { isObject } from "@vue/shared";
```

## 5ã€æ‰“åŒ…é…ç½®

```json
"scripts": {
  "dev": "node scripts/dev.js reactivity -f global -s",
},
```

æ–°å¢ `dev` å‘½ä»¤, æ‰§è¡Œ `scripts/dev.js`, å¹¶ä¼ é€’å‚æ•°

- åªæ‰“åŒ… reactivity æ¨¡å—,
- -fï¼šè¾“å‡ºæ ¼å¼ global,
- -s: å¼€å¯ sourceMap

```js
// path: scripts/dev.js
const minimist = require('minimist')
const execa = require('execa')

const args = minimist(process.argv.slice(2))

// è·å–æ‰§è¡Œå‘½ä»¤æ—¶å€™çš„æ‰“åŒ…å‚æ•°
const target = args._.length ? args._[0] : 'reactivity'
const formats = args.f || 'global'
const sourceMap = args.s || false

execa(
  'rollup',
  [
    '-wc', // --watch --config
    '--environment', // ä¼ å‚
    [
      `TARGET:${target}`,
      `FORMATS:${formats}`,
      sourceMap ? `SOURCE_MAP:true` : '',
    ]
      .filter(Boolean)
      .join(','),
  ],
  {
    stdio: 'inherit', // å­è¿›ç¨‹çš„è¾“å‡ºåœ¨å½“å‰å‘½ä»¤è¡Œä¸­è¾“å‡º
  }
)
```

è„šæœ¬ `dev.js` æ–‡ä»¶ä¸­ä¼šé€šè¿‡ execa å¼€å¯å•ç‹¬çº¿ç¨‹æ‰§è¡Œ `rollup` è¿›è¡Œæ‰“åŒ…ï¼Œå¹¶ä¼ é€’äº†å‚æ•°ï¼Œ `rollup`é…ç½®ä¼šé»˜è®¤ä»æ ¹ç›®å½•æŸ¥æ‰¾

```js
// rollup.config.js

import path from 'path'
import ts from 'rollup-plugin-typescript2'
import json from '@rollup/plugin-json'
import { nodeResolve } from '@rollup/plugin-node-resolve'
import commonjs from '@rollup/plugin-commonjs'

const packageFormats = process.env.FORMATS && process.env.FORMATS.split(',')
const sourcemap = process.env.SOURCE_MAP

// 1ã€éœ€è¦æ ¹æ® target æ‰¾åˆ°è¦æ‰“åŒ…çš„æ¨¡å—
const packagesDir = path.resolve(__dirname, 'packages')
// æ‰“åŒ…å…¥å£
const packageDir = path.resolve(packagesDir, process.env.TARGET)
// å…¥å£æ–‡ä»¶
const resolve = (p) => path.resolve(packageDir, p)
const name = path.basename(packageDir)

const pkg = require(resolve('package.json'))

const outputConfig = {
  'esm-bundler': {
    file: resolve(`dist/${name}.esm-bundler.js`),
    format: 'es',
  },
  cjs: {
    file: resolve(`dist/${name}.cjs.js`),
    format: 'cjs',
  },
  global: {
    file: resolve(`dist/${name}.global.js`),
    format: 'iife',
  },
}

const pkgConfigs = packageFormats || pkg.buildOptions.formats
function createConfig(format, output) {
  output.sourcemap = sourcemap
  output.exports = 'named'
  let external = []
  if (format === 'global') {
    output.name = pkg.buildOptions.name
  } else {
    external = [...Object.keys(pkg.dependencies)]
  }
  return {
    input: resolve('src/index.ts'),
    output,
    external,
    plugins: [json(), ts(), commonjs(), nodeResolve()],
  }
}

// è¿”å›æ•°ç»„ï¼Œä¼šä¾æ¬¡è¿›è¡Œæ‰“åŒ…
export default pkgConfigs.map((format) =>
  createConfig(format, outputConfig[format])
)
```

æ­¤æ—¶ï¼Œæ‰§è¡Œ `npm run dev` å°±ä¼šåœ¨ `packages/reactivity/dist/` ç›®å½•ä¸‹ç”Ÿæˆ `reactivity.global.js` æ–‡ä»¶

è‡ªæ­¤ï¼Œvue3 æºç å¼€å‘ç¯å¢ƒåˆæ­¥æ­å»ºå®Œæˆï¼Œæ‹œ ğŸ‘‹
