è¿™æ˜¯ Vue2.x æºç åˆ†æçš„ç¬¬ä¸€ç¯‡ï¼Œä»‹ç»åœ¨ vue.js ä¸­å¦‚ä½•å¯¹ `Object` å’Œ `Array` è¿›è¡Œå˜åŒ–ä¾¦æµ‹çš„

Vue.js çš„æ¸²æŸ“è¿‡ç¨‹æ˜¯å£°æ˜å¼çš„ï¼Œå½“å†…éƒ¨çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦ä¸æ–­è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œå˜åŒ–ä¾¦æµ‹å°±æ˜¯æ¥ç›‘å¬å†…éƒ¨çŠ¶æ€çš„å˜åŒ–ã€‚

## ä¸€ã€å¯¹ Object çš„ç›‘æµ‹

åœ¨ JS ä¸­å¯ä»¥ä½¿ç”¨ `Object.defineProperty` å’Œ `Proxy` è¿™ä¸¤ä¸ªæ–¹æ³•æ¥ç›‘æµ‹å˜åŒ–ï¼ŒVue 2.x ç‰ˆæœ¬è€ƒè™‘åˆ°å…¼å®¹æ€§ä½¿ç”¨çš„æ˜¯ `Object.defineProperty` æ–¹æ³•ï¼Œè€Œåœ¨ Vue 3.x ä¸­ä½¿ç”¨çš„æ˜¯ `Proxy`ï¼Œåç»­ä»‹ç»

åœ¨ Vue æºç ä¸­ï¼Œå¯¹ `Object.defineProperty` å°è£…å¦‚ä¸‹

```js 
/*
@filePath: src/core/observer/index.js
*/
function defineReactive(obj, key, val){
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      return value
    },
    set: function reactiveSetter (newVal) {
      if (newVal === val) {
        return
      }
      val = newVal
    }
  })
}
```
æ‰€ä»¥ï¼Œå½“ä»`data`çš„`key`ä¸­è¯»å–æ•°æ®æ—¶ï¼Œ`get`å‡½æ•°è¢«è§¦å‘ï¼›å½“å¾€`data`çš„`key`ä¸­è®¾ç½®æ•°æ®ï¼Œ`set`å‡½æ•°è¢«è§¦å‘


### 1.1ã€å¦‚ä½•æ”¶é›†ä¾èµ–ï¼Ÿ

åœ¨ä¸Šé¢ä½¿ç”¨ `Object.defineProperty` å¯¹æ•°æ®ç›‘æµ‹ï¼Œæ˜¯å› ä¸ºå½“æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œéœ€è¦é€šçŸ¥åˆ°é‚£äº›ä½¿ç”¨åˆ°è¯¥æ•°æ®çš„åœ°æ–¹ï¼Œä¾‹å¦‚ğŸ‘‡

```html
<template>
  <div>{{ title }}<div>
</template>
```
åœ¨ç»„ä»¶çš„ `tempalte` ä¸­ä½¿ç”¨æ¥æ•°æ® `title`, æ‰€ä»¥å½“ `title` å˜åŒ–äº†ï¼Œéœ€è¦é€šçŸ¥åˆ° `tempalte`

æ€»ç»“å°±æ˜¯ï¼š**åœ¨`getter`ä¸­æ”¶é›†ä¾èµ–ï¼Œåœ¨`setter`ä¸­è§¦å‘(é€šçŸ¥)ä¾èµ–**

### 1.2ã€æ”¶é›†çš„ä¾èµ–å­˜åœ¨å“ªï¼Ÿ

åœ¨ Vue æºç ä¸­ï¼Œä½¿ç”¨äº†ä¸€ä¸ª `Dep` ç±»æ¥å°è£…ä¾èµ–æ”¶é›†çš„ä»£ç ï¼Œé€šè¿‡è¿™ä¸ªç±»ï¼Œå¯ä»¥**æ”¶é›†ä¾èµ–**ã€**åˆ é™¤ä¾èµ–**æˆ–è€…**å‘ä¾èµ–å‘é€šçŸ¥**



```js
/*
@filePath: src/core/observer/dep.js
*/
export default class Dep {
  constructor () {
    // ç”¨äº†å­˜å‚¨ä¾èµ–
    this.subs = []
  }

  addSub (sub) {
    this.subs.push(sub)
  }

  removeSub (sub) {
    remove(this.subs, sub)
  }

  depend () {
    if (window.target) {
      this.addSub(window.target)
    }
  }

  notify () {
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}
```
åœ¨ `defineReactive` å‡½æ•°ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ Dep ç±»äº†

```js {5-6,11-12,20-21}
/*
@filePath: src/core/observer/index.js
*/
function defineReactive(obj, key, val){
  // 1ã€æ¯ä¸ª key éƒ½åˆ›å»ºä¸€ä¸ªå®ä¾‹æ¥å­˜å‚¨è¯¥å±æ€§çš„ä¾èµ–
  const dep = new Dep()
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      // 2ã€å½“è·å–å±æ€§æ—¶ï¼Œæ”¶é›†ä¾èµ–
      dep.depend()
      return value
    },
    set: function reactiveSetter (newVal) {
      if (newVal === val) {
        return
      }
      val = newVal
      // 3ã€å½“å±æ€§å‘ç”Ÿå˜åŒ–ï¼Œé€šçŸ¥ä¾èµ–
      dep.notify()
    }
  })
}
```
åœ¨æ”¶é›†ä¾èµ–å‰ï¼Œæˆ‘ä»¬å‡è®¾äº†ä¾èµ–ä¿å­˜åœ¨ `window.target` ä¸Šäº†ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ”¶é›†çš„ä¾èµ–æ˜¯å­˜å‚¨åˆ° `Dep` ä¸­çš„

### 1.3ã€ä¾èµ–ä¸ºä½•ç‰©ï¼Ÿ

ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨åˆ°æ•°æ®çš„åœ°æ–¹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦é€šçŸ¥åˆ°çš„åœ°æ–¹ã€‚ä»¥ `data` ä¸­çš„æ•°æ®ä¸ºä¾‹ï¼Œåœ¨ `template`ã€`computed`ã€`watch` ç­‰å¤šä¸ªåœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥ï¼ŒVue.js å†…éƒ¨æŠ½è±¡å‡ºä¸€ä¸ªèƒ½é›†ä¸­å¤„ç†è¿™äº›æƒ…å†µçš„ç±»ï¼Œæ”¶é›†ä¾èµ–æ—¶ï¼Œåªéœ€è¦æ”¶é›†è¿™ä¸ªç±»çš„å®ä¾‹ï¼ŒåŒæ—¶é€šçŸ¥ä¹Ÿåªéœ€è¦é€šçŸ¥åˆ°å®ƒä¸€ä¸ªï¼Œå®ƒå†é€šçŸ¥åˆ°å…¶ä»–åœ°æ–¹ï¼Œè¿™ä¸ªç±»å«åš **Watcher**

æ‰€ä»¥ï¼Œæ”¶é›†ä¾èµ–ï¼Œå°±æ˜¯æ”¶é›† **Watcher** å®ä¾‹

```js {9-10,13-14,20}
/*
@filePath: src/core/observer/watcher.js
*/
export class Watcher{
  constructor(vm, expOrFn, cb){
    this.vm = vm
    this.getter = parsePath(expOrFn)
    this.cb = cb
    // 1ã€åˆå§‹åŒ–ï¼Œè°ƒç”¨ this.get() => this.getter()
    this.value = this.get()
  }
  get(){
    // 2ã€å½“å‰ Watcher å®ä¾‹ä¿å­˜åœ¨ window.target ä¸Š
    window.target = this
    let value = this.getter.call(this.vm, this.vm)
    window.target = undefined
    return value
  }
  update(){
    // 3ã€å±æ€§å˜åŒ–ï¼Œé€šçŸ¥ä¾èµ–ä¼šè°ƒç”¨ update æ–¹æ³•, å†å»æ‰§è¡Œå›è°ƒå‡½æ•°cb
    const oldValue = this.value
    this.value = this.get()
    this.cb.call(this.vm, this.value, oldValue)
  }
}
```
æ‰€ä»¥ï¼Œæ— è®ºæ˜¯ `vm.$watch('obj.name',(value, oldValue) => {})` è¿˜æ˜¯æ¨¡ç‰ˆä¸­ä½¿ç”¨`obj.name`, å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéƒ½éœ€è¦é€šè¿‡ `Watcher` æ¥è¿›è¡Œé€šçŸ¥ï¼Œæ‰§è¡Œå„ç§çš„å›è°ƒå‡½æ•°

### 1.4ã€ç›‘æµ‹æ‰€æœ‰çš„ key

`defineReactive` æ–¹æ³•æ˜¯ç›‘æµ‹æ•°æ®ä¸­çš„å•ä¸ªå±æ€§ï¼Œè€Œæˆ‘ä»¬éœ€è¦ç›‘æµ‹åˆ°æ‰€æœ‰çš„å±æ€§ï¼ˆåŒ…æ‹¬å­å±æ€§ï¼‰ï¼Œå°†å…¶éƒ½è½¬æ¢æˆ `getter/setter` çš„å½¢å¼

```js 
/*
@filePath: src/core/observer/index.js
*/
export class Observer {
  constructor (value: any) {
    this.value = value
    if (!Array.isArray(value)) {
      this.walk(value)
    }
  }

  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i], obj[keys[i]])
    }
  }
}

function defineReactive(obj, key, val){
  /*çœç•¥*/
}
```

### 1.5ã€å±€é™æ€§
Vue.js é€šè¿‡ `Object.defineProperty` æ¥å°†å¯¹è±¡çš„ key è½¬æ¢æˆ `getter/setter` çš„å½¢å¼æ¥è¿½è¸ªå˜åŒ–ï¼Œä½† `getter/setter` åªèƒ½è¿½è¸ªä¸€ä¸ªæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ï¼Œæ— æ³•è¿½è¸ªæ–°å¢çš„å±æ€§å·²ç»åˆ é™¤çš„å±æ€§ï¼Œä¸ºäº†è§£å†³è¿™é—®é¢˜ï¼ŒVue.js æä¾›äº† **`$set`** å’Œ **`$delete`** ä¸¤ä¸ªAPI

### 1.6ã€å°ç»“

å…³äºå¦‚ä½•ç›‘æµ‹Object,æ±‡æ€»å¦‚ä¸‹å›¾ğŸ‘‡

![ç›‘æµ‹Object](/images/vue/defineProperty.png)

## äºŒã€å¯¹ Array çš„ç›‘æµ‹

å¯¹ Array çš„ç›‘æµ‹ä¸èƒ½ä½¿ç”¨ `getter/setter` æ–¹æ³•ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¸¸é€šè¿‡ Array åŸå‹ä¸Šçš„æ–¹æ³•æ¥æ”¹å˜æ•°ç»„çš„å†…å®¹

é€šè¿‡æ±‡æ€»ï¼ŒArray åŸå‹ä¸Šå¯ä»¥æ”¹å˜æ•°ç»„è‡ªèº«å†…å®¹çš„æ–¹æ³•å…± 7 ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š`push`, `pop`, `shift`, `unshift`, `slice`, `sort`, `reverse`

### 2.1ã€æ‹¦æˆªå™¨
æƒ³è¦ç›‘æµ‹æ•°ç»„çš„å˜åŒ–ï¼Œåªéœ€ç”¨ä¸€ä¸ªæ‹¦æˆªå™¨è¦†ç›– ArrayåŸå‹ï¼Œå½“ä½¿ç”¨ä¸Šè¿° 7 ç§æ–¹æ³•ä¿®æ”¹æ•°ç»„æ—¶ï¼Œæ‰§è¡Œçš„æ—¶æ‹¦æˆªå™¨ä¸­çš„æ–¹æ³•

```js {5-7,21-25}
/*
@filePath: src/core/observer/array.js
*/
import { def } from '../util/index'
// 1ã€åŸºäº Array.prototype åˆ›å»ºä¸€ä¸ªæ‹¦æˆªå™¨
const arrayProto = Array.prototype
export const arrayMethods = Object.create(arrayProto)

const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
]

methodsToPatch.forEach(function (method) {
  const original = arrayProto[method]
  // 2ã€åœ¨æ‹¦æˆªå™¨ä¸Šé‡æ–°å®šä¹‰ä¸Šè¿° 7 ä¸ªæ–¹æ³•
  def(arrayMethods, method, function mutator (...args) {
    // 3ã€æ‰§è¡Œæ–¹æ³•æœ¬èº«çš„é€»è¾‘ï¼Œè¿”å›æ‰§è¡Œç»“æœ
    const result = original.apply(this, args)
    return result
  })
})

```

### 2.2ã€å¦‚ä½•æ”¶é›†ä¾èµ–ï¼Ÿ

å¯¹æ•°ç»„è€Œè¨€ï¼Œé€šçŸ¥ä¾èµ–è‚¯å®šæ˜¯åœ¨æ‹¦æˆªå™¨ä¸­ï¼Œé‚£ä¹ˆï¼Œæ•°ç»„åœ¨å“ªé‡Œæ”¶é›†ä¾èµ–å‘¢ï¼Ÿçœ‹ä¸ªä¾‹å­

```js
{
  list: [1,2,3]
}
```
ä»¥ä¸Šé¢æ•°æ®ä¸ºä¾‹ï¼Œåªæœ‰é€šè¿‡ `list` å±æ€§ï¼Œæ‰èƒ½è·å–è¿™ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆè¯»å– `list` å±æ€§ï¼Œä¸€å®šä¸ºè§¦å‘`list`å±æ€§çš„ `getter` æ–¹æ³•ï¼Œæ‰€ä»¥æ•°ç»„ä¹Ÿæ˜¯åœ¨ `getter` ä¸­æ”¶é›†ä¾èµ–

æ‰€ä»¥ï¼Œ**Array åœ¨ getter ä¸­æ”¶é›†ä¾èµ–ï¼Œåœ¨æ‹¦æˆªå™¨ä¸­è§¦å‘(é€šçŸ¥)ä¾èµ–**

### 2.3ã€å­˜å‚¨ä¾èµ–

Array çš„ä¾èµ–ä¹Ÿæ˜¯é€šè¿‡ Dep å®ä¾‹æ¥è¿›è¡Œä¿å­˜ï¼Œä½†ä¸ Object ä¸åŒçš„æ˜¯ï¼ŒVue.js æŠŠ Array çš„ dep æ”¾åˆ° Observer ä¸­äº†ï¼Œè€Œå¯¹è±¡å±æ€§å¯¹åº”çš„ dep åˆ™åœ¨ defineReactive å‡½æ•°ä¸­

ä¹‹æ‰€ä»¥æ”¾åœ¨ Observer ä¸­, æ˜¯å› ä¸ºåœ¨ getter å’Œæ‹¦æˆªå™¨ä¸­éƒ½éœ€è¦è®¿é—®åˆ°è¿™ä¸ª dep å®ä¾‹

```js {7,9,15-20}
/*
@filePath: src/core/observer/index.js
*/
export class Observer {
  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    if (Array.isArray(value)) {
      this.observeArray(value) 
    } else {
      this.walk(value)
    }
  }

  observeArray (items: Array<any>) {
    for (let i = 0, l = items.length; i < l; i++) {
      // 2ã€å¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„ï¼Œéœ€è¦ç›‘æµ‹æ•°ç»„æ¯ä¸€é¡¹
      observe(items[i])
    }
  }
}
```

### 2.4ã€æ”¶é›†ä¾èµ–
æˆ‘ä»¬éœ€è¦åœ¨ getter ä¸­è®¿é—®åˆ° dep å®ä¾‹ï¼Œæ‰èƒ½æ”¶é›†ä¾èµ–ï¼Œä»£ç å¦‚ä¸‹

```js {5-6,11-14,26-37}
/*
@filePath: src/core/observer/index.js
*/
function defineReactive(obj, key, val){
  // 1ã€æ­¤å¤„å‡è®¾ val æ˜¯ä¸ªæ•°ç»„
  let childOb = observer(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      // 2ã€æ”¶é›†ä¾èµ–
      if (childOb) {
        childOb.dep.depend()
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      if (newVal === val) {
        return
      }
      val = newVal
    }
  })
}

export function observe (value){
  if (!isObject(value) || value instanceof VNode) {
    return
  }
  let ob: Observer | void
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__ // å½“æ•°æ®å·²ç»æ£€æµ‹è¿‡ï¼Œç›´æ¥è¿”å›
  } else {
    ob = new Observer(value) // è¿›è¡Œæ£€æµ‹
  }
  return ob
}
```
ä»¥æ•°æ® `list: [1,2,3]` ä¸ºä¾‹ï¼Œå½“è®¿é—®å±æ€§ list, ä¼šå¯¹æ•°ç»„ `[1,2,3]` è¿›è¡Œç›‘æµ‹



### 2.5ã€é€šçŸ¥ä¾èµ–

Array å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦åœ¨æ‹¦æˆªå™¨ä¸­è®¿é—®åˆ° Observer å®ä¾‹ï¼Œé€šè¿‡å…¶ dep å±æ€§é€šçŸ¥ä¾èµ–

```js {7}
/*
@filePath: src/core/observer/index.js
*/
export class Observer {
  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    def(value, '__ob__', this)
    if (Array.isArray(value)) {
      this.observeArray(value) 
    } else {
      this.walk(value)
    }
  }
  //...
}
```

åœ¨ `value` ä¸Šå¢åŠ  `__ob__` å±æ€§å³å¯è®¿é—®åˆ° `Observer` å®ä¾‹ï¼Œç»§è€Œå¯ä»¥è®¿é—® `dep` å±æ€§

æ¥ä¸‹æ¥ï¼Œåªéœ€è¦åœ¨æ‹¦æˆªå™¨ä¸­é€šçŸ¥ä¾èµ–, åŒæ—¶ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ `push`, `unshift`, `splice` æ—¶ä¼šå¾€æ•°ç»„ä¸­æ·»åŠ æ–°å…ƒç´ ï¼Œæ–°å¢çš„å…ƒç´ ä¹Ÿéœ€è¦è¢«ç›‘æµ‹åˆ°ã€‚

```js {22-35}
/*
@filePath: src/core/observer/array.js
*/
import { def } from '../util/index'
const arrayProto = Array.prototype
export const arrayMethods = Object.create(arrayProto)

const methodsToPatch = [
  'push',
  'pop',
  'shift',
  'unshift',
  'splice',
  'sort',
  'reverse'
]

methodsToPatch.forEach(function (method) {
  const original = arrayProto[method]
  def(arrayMethods, method, function mutator (...args) {
    const result = original.apply(this, args)
    const ob = this.__ob__
    let inserted
    switch (method) {
      case 'push':
      case 'unshift':
        inserted = args
        break
      case 'splice':
        inserted = args.slice(2)
        break
    }
    if (inserted) ob.observeArray(inserted)
    // notify change
    ob.dep.notify()
    return result
  })
})
```

### 2.6ã€å±€é™æ€§

é€šè¿‡ Array ä¸‹æ ‡ä¿®æ”¹å…ƒç´ çš„å€¼ï¼Œæˆ–è€…è®¾ç½® list.length = 0 æ¥æ¸…ç©ºæ•°ç»„ç­‰ï¼ŒVue.js éƒ½æ— æ³•ç›‘æµ‹æ•°ç»„çš„å˜åŒ–








