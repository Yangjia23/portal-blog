åˆ©ç”¨ `github` + `github action` è‡ªåŠ¨æ„æˆ `docker` é•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘ç§æœ‰é•œåƒåº“

## ä¸€ã€é¡¹ç›®æ­å»º

åœ¨ `github` åˆ›å»ºé¡¹ç›®å `clone` åˆ°æœ¬åœ°ï¼Œåˆå§‹åŒ–åï¼Œåœ¨æ ¹ç›®å½•åˆ›å»º `dockerFile` æ–‡ä»¶

```
FROM nginx:1.15-alpine

COPY html /etc/nginx/html
WORKDIR /etc/nginx/html
```

åç»­ä¼šæ ¹æ®æ­¤æ–‡ä»¶åˆ›å»º docker é•œåƒ 

## äºŒã€æ³¨å†Œé˜¿é‡Œäº‘ç§æœ‰é•œåƒæœåŠ¡

è®¿é—® [å®¹å™¨é•œåƒæœåŠ¡](https://cr.console.aliyun.com/cn-hangzhou/instances) æ ¹æ®æ­¥éª¤å³å¯åˆ›å»ºä¸ªäººç§æœ‰é•œåƒä»“åº“ï¼Œä¸»è¦æ“ä½œå¦‚ä¸‹

### 2.1ã€ç™»å½•é˜¿é‡Œäº‘Docker Registry
```
docker login --username=29964*****@qq.com registry.cn-hangzhou.aliyuncs.com
```

### 2.2ã€æ‹‰å–é•œåƒ
```
docker pull registry.cn-hangzhou.aliyuncs.com/[å‘½åç©ºé—´]/[é•œåƒåç§°]:[é•œåƒç‰ˆæœ¬å·]
```

### 2.3ã€é•œåƒæ¨é€åˆ°Registry
```shell
$ docker login --username=29964*****@qq.com registry.cn-hangzhou.aliyuncs.com
$ docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/[å‘½åç©ºé—´]/[é•œåƒåç§°]:[é•œåƒç‰ˆæœ¬å·]
$ docker push registry.cn-hangzhou.aliyuncs.com/[å‘½åç©ºé—´]/[é•œåƒåç§°]:[é•œåƒç‰ˆæœ¬å·]
```


## ä¸‰ã€workflow

`github action` å¯åœ¨ä»£ç æäº¤æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œä»£ç ç¼–è¯‘ã€é•œåƒæ„å»ºç­‰å·¥ä½œã€‚æ ¹ç›®å½•æ–°å»º `.github/workflows/deploy.yml` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

```yaml
name: k8s-image-ci

on:
  push:
    branches: [main] # main åˆ†æ”¯æœ‰ push æ—¶è§¦å‘
    
# å·¥ä½œæµç¨‹ï¼Œå¯åŒ…å«å¤šä¸ªä½œä¸š
jobs:

  # ä½œä¸š1åç§°
  build:
    # æŒ‡å®šçš„è¿è¡Œå™¨ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä½œä¸šåŒ…å«ä¸€ç³»åˆ—ä»»åŠ¡ï¼Œç§°ä¸º steps
    steps:
      # æ£€å‡ºå½“å‰ä»£ç ï¼ˆè§¦å‘å·¥ä½œæµæ—¶çš„commitsï¼‰
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        
      # ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: Login to Ali Docker
        uses: docker/login-action@v1
        # é…ç½®ç™»å½•ä¿¡æ¯ï¼Œsecrets å˜é‡åœ¨ github settings -> secrets ä¸­è®¾ç½®
        with:
          registry: ${{ secrets.ALI_DOCKER_HUB_REGISTRY }}
          username: ${{ secrets.ALI_DOCKER_HUB_USN }}
          password: ${{ secrets.ALI_DOCKER_HUB_PWD }}

      # æ„å»ºé•œåƒå¹¶ä¸Šä¼ åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“ (è‡ªè¡Œç™¾åº¦åˆ›å»ºè‡ªå·±çš„é•œåƒä»“åº“)
      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: registry.cn-hangzhou.aliyuncs.com/yjay/k8s-cicd:latest
```

åœ¨æ¨é€ä»£ç åˆ°ä»“åº“çš„ main åˆ†æ”¯åï¼Œä¼šè‡ªåŠ¨æ„å»ºæœ€æ–°çš„ docker é•œåƒï¼Œæ¨é€åˆ°ç§æœ‰ä»“åº“